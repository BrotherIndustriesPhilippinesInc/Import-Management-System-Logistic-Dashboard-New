@{
    ViewData["Title"] = "Home Page";
}

<div class="w-100">
    <div class="w-100 d-flex mt-5">
        <div class="w-100 d-flex flex-column">
            <table class="filter-table w-100 fw-bold">
                <tr class="home-bg text-white no-wrap">
                    <th class="text-center" style="
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            height: 50px;
                    ">
                        <iconify-icon class="home-icon" icon="tabler:ship" width="32" height="32"></iconify-icon>
                        <span class="home-header" style="vertical-align: middle">VESSEL UPDATES</span>
                    </th>
                    <th class="text-center">
                        <img src="~/resources/logo/Bureau_of_Customs.svg" width="32px" />
                        <span class="home-header">IMPORT DELIVERY</span>
                    </th>
                    <th class="text-center" colspan="2">
                        <span><iconify-icon class="home-icon" icon="roentgen:crane" width="32" height="32"></iconify-icon></span>
                        <div class="d-inline-block home-header">PHIL. PORT UPDATE <br /> (PORT UTILIZATION)</div>
                    </th>
                    <th class="text-center" colspan="2">
                        <span><iconify-icon class="home-icon" icon="roentgen:crane" width="32" height="32"></iconify-icon></span>
                        <div class="d-inline-block home-header">PHIL. PORT UPDATE <br /> (BERTHING STATUS)</div>
                    </th>
                    <th class="text-center" style="
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            height: 50px;">
                        <span><iconify-icon icon="mingcute:announcement-fill" width="32" height="32" style="color: #C00000; transform: rotate(-30deg)" ></iconify-icon></span>
                        <div class="d-inline-block home-header">ANNOUNCEMENT</div>
                    </th>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td class="text-center fw-bold home-header">Manila North</td>
                    <td class="text-center fw-bold home-header">Batangas</td>
                    <td class="text-center fw-bold home-header">Manila North</td>
                    <td class="text-center fw-bold home-header">Batangas</td>
                    <td class="border-1" rowspan="4" style="vertical-align: top;">
                        <div class="d-flex gap-2 mb-2 justify-content-end">
                            <a href="/Announcements/Create" class="btn btn-primary p-1" data-bs-toggle="modal" data-bs-target="#announcementCreateModal">
                                Create
                            </a>
                            <a href="/Announcements/Index"  class="btn btn-warning p-1">
                                Edit
                            </a>
                        </div>
                        <div class="d-flex flex-column gap-2 align-items-center" id="announcement-container" style="height: 120px; overflow-y: auto;">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="filter-inputs text-start"><input class="vessel_Updates main-checkbox" id="vesselUpdates_Normal" type="checkbox" /><label for="vesselUpdates_Normal">Normal</label></td>
                    <td class="filter-inputs text-start"><input class="importDelivery_Updates main-checkbox" id="importDelivery_Normal" type="checkbox" /><label for="importDelivery_Normal">Normal</label></td>
                    <td class="filter-inputs text-start"><input class="manilaPortUtilization_Updates main-checkbox" id="philPortUpdate_Manila_North_Normal" type="checkbox" /><label for="philPortUpdate_Manila_North_Normal">Normal</label></td>
                    <td class="filter-inputs text-start"><input class="batangasPortUtilization_Updates main-checkbox" id="philPortUpdate_Batangas_Normal" type="checkbox" /><label for="philPortUpdate_Batangas_Normal">Normal</label></td>
                    <td class="filter-inputs text-start"><input class="manilaBerthStatus_Updates main-checkbox" id="berthingStatus_Manila_North_Normal" type="checkbox" /><label for="berthingStatus_Manila_North_Normal">Normal</label></td>
                    <td class="filter-inputs text-start"><input class="batangasBerthStatus_Updates main-checkbox" id="berthingStatus_Batangas_Normal" type="checkbox" /><label for="berthingStatus_Batangas_Normal">Normal</label></td>
                </tr>
                <tr>
                    <td class="filter-inputs text-start"><input class="vessel_Updates main-checkbox" id="vesselUpdates_Critical" type="checkbox" /><label for="vesselUpdates_Critical">Critical</label></td>
                    <td class="filter-inputs text-start"><input class="importDelivery_Updates main-checkbox" id="importDelivery_Critical" type="checkbox" /><label for="importDelivery_Critical">Critical</label></td>
                    <td class="filter-inputs text-start"><input class="manilaPortUtilization_Updates main-checkbox" id="philPortUpdate_Manila_North_Critical" type="checkbox" /><label for="philPortUpdate_Manila_North_Critical">Critical</label></td>
                    <td class="filter-inputs text-start"><input class="batangasPortUtilization_Updates main-checkbox" id="philPortUpdate_Batangas_Critical" type="checkbox" /><label for="philPortUpdate_Batangas_Critical">Critical</label></td>
                    <td class="filter-inputs text-start"><input class="manilaBerthStatus_Updates main-checkbox" id="berthingStatus_Manila_North_Critical" type="checkbox" /><label for="berthingStatus_Manila_North_Critical">Critical</label></td>
                    <td class="filter-inputs text-start"><input class="batangasBerthStatus_Updates main-checkbox" id="berthingStatus_Batangas_Critical" type="checkbox" /><label for="berthingStatus_Batangas_Critical">Critical</label></td>
                </tr>
                <tr>
                    <td class="filter-inputs text-start"><input class="vessel_Updates main-checkbox" id="vesselUpdates_Serious" type="checkbox" /><label for="vesselUpdates_Serious">Serious</label></td>
                    <td class="filter-inputs text-start"><input class="importDelivery_Updates main-checkbox" id="importDelivery_Serious" type="checkbox" /><label for="importDelivery_Serious">Serious</label></td>
                    <td class="filter-inputs text-start"><input class="manilaPortUtilization_Updates main-checkbox" id="philPortUpdate_Manila_North_Serious" type="checkbox" /><label for="philPortUpdate_Manila_North_Serious">Serious</label></td>
                    <td class="filter-inputs text-start"><input class="batangasPortUtilization_Updates main-checkbox" id="philPortUpdate_Batangas_Serious" type="checkbox" /><label for="philPortUpdate_Batangas_Serious">Serious</label></td>
                    <td class="filter-inputs text-start"><input class="manilaBerthStatus_Updates main-checkbox" id="berthingStatus_Manila_North_Serious" type="checkbox" /><label for="berthingStatus_Manila_North_Serious">Serious</label></td>
                    <td class="filter-inputs text-start"><input class="batangasBerthStatus_Updates main-checkbox" id="berthingStatus_Batangas_Serious" type="checkbox" /><label for="berthingStatus_Batangas_Serious">Serious</label></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div class="fst-italic">
    <p><h5 class="home-header">Note:</h5> For full details, please see SF delivery info</p>
</div>

<div class="mb-5">
    <table id="vessel-status-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="8" >Vessel Status</th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">BIL No.</th>
                <th class="text-center import-landing-table-header">Shipper</th>
                <th class="text-center import-landing-table-header">Original ETA Port</th>
                <th class="text-center import-landing-table-header">Revised ETA Port</th>
                <th class="text-center import-landing-table-header">Reasons</th>
                <th class="text-center import-landing-table-header">BIPH Action</th>
                <th class="text-center import-landing-table-header"></th>
            </tr>
        </thead>
    </table>
</div>

<div class="mb-5">
    <table id="import-delivery-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="12">Import Delivery</th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">BIL No.</th>
                <th class="text-center import-landing-table-header">Shipper</th>
                <th class="text-center import-landing-table-header">Original ETA Port</th>
                <th class="text-center import-landing-table-header">Revised ETA Port</th>
                <th class="text-center import-landing-table-header">Reasons</th>
                <th class="text-center import-landing-table-header">BIPH Action</th>
                <th class="text-center import-landing-table-header">Created By</th>
                <th class="text-center import-landing-table-header">Created Date</th>
                <th class="text-center import-landing-table-header">Updated By</th>
                <th class="text-center import-landing-table-header">Updated Date</th>
                <th class="text-center import-landing-table-header"></th>
            </tr>
        </thead>

    </table>
</div>

<div class="mb-5">
    <table id="port-utilization-manila-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="9">Port Utilization - Manila North (MICT) </th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">Port ID</th>
                <th class="text-center import-landing-table-header">Start Date</th>
                <th class="text-center import-landing-table-header">End Date</th>
                <th class="text-center import-landing-table-header">Week</th>
                <th class="text-center import-landing-table-header">Overall Yard Utilization</th>
                <th class="text-center import-landing-table-header">Vessels At Berth</th>
                <th class="text-center import-landing-table-header">Vessels At Anchorage Waiting</th>
                <th class="text-center import-landing-table-header">Last Update</th>
            </tr>
        </thead>

    </table>
</div>

<div class="mb-5">
    <table id="port-utilization-batangas-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="9">Port Utilization - Batangas (POB)</th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">Port ID</th>
                <th class="text-center import-landing-table-header">Start Date</th>
                <th class="text-center import-landing-table-header">End Date</th>
                <th class="text-center import-landing-table-header">Week</th>
                <th class="text-center import-landing-table-header">Overall Yard Utilization</th>
                <th class="text-center import-landing-table-header">Vessels At Berth</th>
                <th class="text-center import-landing-table-header">Vessels At Anchorage Waiting</th>
                <th class="text-center import-landing-table-header">Last Update</th>
            </tr>
        </thead>

    </table>
</div>

<div class="mb-5">
    <table id="berthing-manila-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="4">Berthing Status - Manila North (MICT)</th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">Date</th>
                <th class="text-center import-landing-table-header">Vessels At Berth</th>
                <th class="text-center import-landing-table-header">Vessels At Anchorage</th>
            </tr>
        </thead>

    </table>
</div>

<div class="mb-5">
    <table id="berthing-batangas-table" class="table table-bordered border-dark">
        <thead>
            <tr>
                <th class="text-center import-landing-table-header" colspan="4">Berthing Status - Batangas (POB)</th>
            </tr>
            <tr>
                <th class="text-center import-landing-table-header">ID</th>
                <th class="text-center import-landing-table-header">Date</th>
                <th class="text-center import-landing-table-header">Vessels At Berth</th>
                <th class="text-center import-landing-table-header">Vessels At Anchorage</th>
            </tr>
        </thead>

    </table>
</div>



@* MODALS *@
<div class="modal fade" id="importDeliveryCreateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Create Import Delivery</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" name="id" id="id" />
                <input type="hidden" name="createdBy" id="createdBy" />
                <input type="hidden" name="createdDate" id="createdDate" />
                <input type="hidden" name="updatedBy" id="updatedBy" />
                <input type="hidden" name="updatedDate" id="updatedDate" />

                <div class="mb-3">
                    <label for="recipient-name" class="col-form-label">BIL No.</label>
                    <input type="text" class="form-control" id="bilNo" name="bilNo">
                </div>
                <div class="mb-3">
                    <label for="recipient-name" class="col-form-label">Shipper</label>
                    <input type="text" class="form-control" id="shipper" name="shipper">
                </div>
                <div class="mb-3">
                    <label for="message-text" class="col-form-label">Original ETA Port</label>
                    <input type="date" class="form-control" id="originalETA" name="originalETA">
                </div>
                <div class="mb-3">
                    <label for="message-text" class="col-form-label">Revised ETA Port</label>
                    <input type="date" class="form-control" id="revisedETA" name="revisedETA">
                </div>
                <div class="mb-3">
                    <label for="message-text" class="col-form-label">Reasons</label>
                    <textarea type="text" class="form-control" id="reasons" name="reasons"></textarea>
                </div>
                <div class="mb-3">
                    <label for="message-text" class="col-form-label">BIPH Action</label>
                    <textarea type="text" class="form-control" id="biphAction" name="biphAction"></textarea>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createImportDeliveryButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importDeliveryEditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Import Delivery</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/" method="post">
                <div class="modal-body">

                    <input type="hidden" name="id" id="edit-id" />
                    <input type="hidden" name="createdBy" id="edit-createdBy" />
                    <input type="hidden" name="createdDate" id="edit-createdDate" />
                    <input type="hidden" name="updatedBy" id="edit-updatedBy" />
                    <input type="hidden" name="updatedDate" id="edit-updatedDate" />

                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">BIL No.</label>
                        <input type="text" class="form-control" id="edit-bilNo" name="bilNo">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Shipper</label>
                        <input type="text" class="form-control" id="edit-shipper" name="shipper">
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">Original ETA Port</label>
                        <input type="date" class="form-control" id="edit-originalETA" name="originalETA">
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">Revised ETA Port</label>
                        <input type="date" class="form-control" id="edit-revisedETA" name="revisedETA">
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">Reasons</label>
                        <textarea type="text" class="form-control" id="edit-reasons" name="reasons"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">BIPH Action</label>
                        <textarea type="text" class="form-control" id="edit-biphAction" name="biphAction"></textarea>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="editImportDeliveryButton" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="announcementCreateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Create Announcement</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" name="announcement-id" id="announcement-id"  />

                <div class="mb-3">
                    <label for="title" class="col-form-label">Title</label>
                    <input type="text" class="form-control" id="announcement-title" name="title">
                </div>
                <div class="mb-3">
                    <label for="description" class="col-form-label">Description</label>
                    <textarea type="text" class="form-control" id="announcement-description" name="description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createAnnouncement">Save</button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("GenericModal", new GenericModalViewModel
{
    ModalId = "VesselStatusModal",
    Title = "Create Vessel Status",
    SaveButtonId = "createVesselStatusButton",
    Body = Html.Raw(@"
        <input type='hidden' id='vessel_status_id' />

        <div class='mb-3'>
            <label>BIL No.</label>
            <input class='form-control' id='vesselStatus-bilNo'>
        </div>

        <div class='mb-3'>
            <label>Shipper</label>
            <input class='form-control' id='vesselStatus-shipper'>
        </div>

        <div class='mb-3'>
            <label>Original ETA Port</label>
            <input class='form-control' id='vesselStatus-originalETA'>
        </div>

        <div class='mb-3'>
            <label>Revised ETA Port</label>
            <input class='form-control' id='vesselStatus-revisedETA'>
        </div>

        <div class='mb-3'>
            <label>Reasons</label>
            <input class='form-control' id='vesselStatus-reasons'>
        </div>
    ")
})

@section Scripts {
    <script type="module" src="~/js/page-scripts/ImportModule/Loader.js"></script>
    <script>
        
        $(async function(){
            $(".main-checkbox").on("click", function () {
                if ($(this).is(":checked")) {
                        console.log($(this).parents("td").text());
                    if($(this).parents("td").text() == "Normal") {
                        $(this).parents("td").addClass("normal-background");
                    }else if($(this).parents("td").text() == "Critical") {
                        $(this).parents("td").addClass("critical-background");
                    }else if($(this).parents("td").text() == "Serious") {
                        $(this).parents("td").addClass("serious-background");
                    }
                } else {
                    $(this).parents("td").removeClass();
                    $(this).parents("td").addClass("filter-inputs text-start");
                }
            });

            //#region Vessel Status
            
                //Vessel Status
                

                $(".vessel_Updates").on('click', function() {
                    filteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.vessel_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        vessel_status_table.clear().rows.add(response).draw();
                        return;
                    }

                    // Define filtering rules per category (day ranges example)
                    const categoryRanges = {
                        "Normal": [0, 2],
                        "Critical": [3, 6],
                        "Serious": [7, Infinity]
                        // Adjust ranges if needed
                    };

                    response.forEach(item => {
                        let originalDate = new Date(item.original_ETA);
                        let revisedDate = new Date(item.latest_ETA);
                        const diffTime = Math.abs(revisedDate - originalDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        // Check if any of the selected categories match this item's day difference
                        for (let category of clickedCategories) {
                            let [minDays, maxDays] = categoryRanges[category] || [0, Infinity];
                            if (diffDays >= minDays && diffDays <= maxDays) {
                                filteredData.push(item);
                                break; // Stop checking other categories for this item
                            }
                        }
                    });

                    // Update DataTable
                    vessel_status_table.clear().rows.add(filteredData).draw();
                });
            //#endregion
            
            //#region Import Delivery
                let importDelivery = await fetch(`${API_BASE_URL}/api/ImportDeliveries/`);
                let importDeliveryResponse = await importDelivery.json();
                let importDeliveryFilteredData = [];

                const import_delivery_table = $('#import-delivery-table').DataTable({
                    layout: {
                        topStart: {
                            buttons: ['colvis', {
                                text: 'Create New',
                                className: 'create-new-button btn btn-primary',
                                action: function ( e, dt, node, config ) {
                                    $('#importDeliveryCreateModal').modal('show');
                                }
                            } ]
                        },
                        topEnd: ['search', 'pageLength'],

                    },
                    data: importDeliveryResponse,

                    order: [[0, "desc"]],
                    columnDefs: [
                        {className: "p-1", target: "_all"}
                    ],
                    columns: [
                        // SHIPMENT DETAILS
                        { data: 'id', visible: false },
                        { data: 'biL_No' },
                        { data: 'shipper'},
                        { data: 'original_ETA_Port', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'revised_ETA_Port', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'reasons'},
                        { data: 'bipH_Action'},
                        { data: 'createdBy', visible: false },
                        { data: 'createdDate', visible: false, render: 
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'updatedBy', visible: false },
                        { data: 'updatedDate', visible: false },
                        { data: null, orderable: false, render: function (data, type, row){
                            return `
                                <div class="d-flex gap-3 justify-content-center">
                                    <button class="btn btn-secondary editImportDelivery" data-id="${row.id}">Edit</button>
                                    <button class="btn btn-danger deleteImportDelivery" data-id="${row.id}">Delete</button>
                                </div>
                            `;}
                        },
                    ],

                });

                $("#createImportDeliveryButton").on('click', function() {
                    let user = localStorage.getItem('user');
                    user = JSON.parse(user);
                    let adid = user.EmpNo;
                    let data = {
                        "biL_No": $("#bilNo").val(),
                        "shipper": $("#shipper").val(),
                        "original_ETA_Port": $("#originalETA").val(),
                        "revised_ETA_Port": $("#revisedETA").val(),
                        "reasons": $("#reasons").val(),
                        "bipH_Action": $("#biphAction").val(),
                        "createdBy": adid
                    };

                    $.ajax({
                        type: 'POST',
                        url: `${API_BASE_URL}/api/ImportDeliveries`,
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: async function(response) {
                            import_delivery_table.row.add(response).draw();
                            $('#importDeliveryCreateModal').modal('hide');

                            swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Import Delivery created successfully',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            importDelivery = await fetch(`${API_BASE_URL}/api/ImportDeliveries/`);
                            importDeliveryResponse = await importDelivery.json();
                        },
                        error: function(response) {
                            console.log(response);
                        }
                    });
                });

                $(document).on('click', ('.editImportDelivery'), function(){
                    //get table data
                    let row = import_delivery_table.row($(this).parents('tr')).data();
                    let id = row.id;
                    let bilNo = row.biL_No;
                    let shipper = row.shipper;
                    let originalETA = row.original_ETA_Port;
                    let revisedETA = row.revised_ETA_Port;
                    let reasons = row.reasons;
                    let biphAction = row.bipH_Action;
                    let createdBy = row.createdBy;
                    let createdDate = row.createdDate;
                    let updatedBy = row.updatedBy;
                    let updatedDate = row.updatedDate;

                    //set values
                    $('#edit-id').val(id);
                    $('#edit-bilNo').val(bilNo);
                    $('#edit-shipper').val(shipper);
                    $('#edit-originalETA').val(originalETA);
                    $('#edit-revisedETA').val(revisedETA);
                    $('#edit-reasons').val(reasons);
                    $('#edit-biphAction').val(biphAction);
                    $('#edit-createdBy').val(createdBy);
                    $('#edit-createdDate').val(createdDate);
                    $('#edit-updatedBy').val(updatedBy);
                    $('#edit-updatedDate').val(updatedDate);

                    $('#importDeliveryEditModal').modal('show');

                });

                $("#editImportDeliveryButton").on('click', function(){
                    let user = localStorage.getItem('user');
                    user = JSON.parse(user);
                    let adid = user.EmpNo;
                    let data = {
                        "id": $("#edit-id").val(),
                        "biL_No": $("#edit-bilNo").val(),
                        "shipper": $("#edit-shipper").val(),
                        "original_ETA_Port": $("#edit-originalETA").val(),
                        "revised_ETA_Port": $("#edit-revisedETA").val(),
                        "reasons": $("#edit-reasons").val(),
                        "bipH_Action": $("#edit-biphAction").val(),
                        "updatedBy": adid
                    };


                    $.ajax({
                        type: 'POST',
                        url: `${API_BASE_URL}/api/ImportDeliveries/${data.id}`,
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function (response) {
                            const rowIndex = import_delivery_table
                                .rows()
                                .indexes()
                                .filter(i => import_delivery_table.row(i).data().id == response.id)[0];

                            import_delivery_table.row(rowIndex).data(response).draw(false);

                            $('#importDeliveryEditModal').modal('hide');
                        },

                        error: function(response) {
                            console.log(response);
                        }
                    });
                });

                $(document).on('click', '.deleteImportDelivery', function () {
                    const button = this;
                    const id = $(button).data('id');

                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, delete it!'
                    }).then(result => {
                        if (!result.isConfirmed) return;

                        $.ajax({
                            type: 'POST',
                            url: `${API_BASE_URL}/api/ImportDeliveries/Delete/${id}`,
                            success: function () {
                                import_delivery_table
                                    .row($(button).parents('tr'))
                                    .remove()
                                    .draw(false);

                                Swal.fire('Deleted!', 'Import Delivery removed.', 'success');
                            }
                        });
                    });
                });

                $(".importDelivery_Updates").on('click', function() {
                    importDeliveryFilteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.importDelivery_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        import_delivery_table.clear().rows.add(importDeliveryResponse).draw();
                        return;
                    }

                    // Define filtering rules per category (day ranges example)
                    const categoryRanges = {
                        "Normal": [1, 2],
                        "Critical": [3, 5],
                        "Serious": [6, Infinity]
                        // Adjust ranges if needed
                    };

                    importDeliveryResponse.forEach(item => {
                        let originalDate = new Date(item.original_ETA_Port);
                        let revisedDate = new Date(item.revised_ETA_Port);
                        const diffTime = Math.abs(revisedDate - originalDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        // Check if any of the selected categories match this item's day difference
                        for (let category of clickedCategories) {
                            let [minDays, maxDays] = categoryRanges[category] || [0, Infinity];
                            if (diffDays >= minDays && diffDays <= maxDays) {
                                importDeliveryFilteredData.push(item);
                                break; // Stop checking other categories for this item
                            }
                        }
                    });

                    // Update DataTable
                    import_delivery_table.clear().rows.add(importDeliveryFilteredData).draw();
                });
            //#endregion

            //#region Port Utilization
                const manilaPortName = "Manila North (MICT)";
                const batangasPortName = "Batangas (POB)";
                let year = 2025;

                let manilaPortUtilization = await fetch(`${API_BASE_URL}/api/Ports/SpecificPorts/${manilaPortName}/${year}`);
                manilaPortUtilization = await manilaPortUtilization.json();
                let batangasPortUtilization = await fetch(`${API_BASE_URL}/api/Ports/SpecificPorts/${batangasPortName}/${year}`);
                batangasPortUtilization = await batangasPortUtilization.json();

                //Manila North
                let manilaPortUtilizationFilteredData = [];
                const manilaPortUtilizationTable = $('#port-utilization-manila-table').DataTable({
                    layout: {
                        topStart: {
                            buttons: ['colvis']
                        },
                        topEnd: ['search', 'pageLength'],

                    },
                    data: manilaPortUtilization.portUtilizations,
                    order: [[0, "desc"]],
                    columnDefs: [
                        {className: "p-1", target: "_all"}
                    ],
                    columns: [
                        // SHIPMENT DETAILS
                        { data: 'id', visible: false },
                        { data: 'portId', visible: false },
                        { data: 'startDate', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                    },
                        { data: 'endDate', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'week'},
                        { data: 'overall_Yard_Utilization', render: 
                            function (data, type) {
                                if (type === 'display') {
                                    return data + "%";
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'vessels_At_Berth'},
                        { data: 'vessels_At_Anchorage_Waiting'},
                        { data: 'last_Update', visible: false }
                    ],

                });

                $(".manilaPortUtilization_Updates").on('click', function() {
                    manilaPortUtilizationFilteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.manilaPortUtilization_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        manilaPortUtilizationTable.clear().rows.add(manilaPortUtilization.portUtilizations).draw();
                        return;
                    }

                    const categoryRanges = {
                        "Normal": [0, 85],
                        "Critical": [86, 96],
                        "Serious": [97, Infinity]
                    };

                    manilaPortUtilization.portUtilizations.forEach(item => {
                        const value = parseFloat(item.overall_Yard_Utilization);
                        if (isNaN(value)) return; // skip invalid values

                        // Find which category this value belongs to
                        for (let category in categoryRanges) {
                            const [min, max] = categoryRanges[category];
                            if (value >= min && value <= max) {
                                // Only include if this category is selected
                                if (clickedCategories.includes(category)) {
                                    manilaPortUtilizationFilteredData.push(item);
                                }
                                break; // stop checking other categories
                            }
                        }
                    });

                    // Update DataTable
                    manilaPortUtilizationTable.clear().rows.add(manilaPortUtilizationFilteredData).draw();
                });

                //Batangas
                let batangasPortUtilizationFilteredData = [];
                const batangasPortUtilizationTable = $('#port-utilization-batangas-table').DataTable({
                    layout: {
                        topStart: {
                            buttons: ['colvis']
                        },
                        topEnd: ['search', 'pageLength'],

                    },
                    data: batangasPortUtilization.portUtilizations,
                    order: [[0, "desc"]],
                    columnDefs: [
                        {className: "p-1", target: "_all"}
                    ],
                    columns: [
                        // SHIPMENT DETAILS
                        { data: 'id', visible: false },
                        { data: 'portId', visible: false },
                        { data: 'startDate', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                    },
                        { data: 'endDate', render:
                            function (data, type) {
                                //format date 2025-12-16T22:55:15.1156539Z to mm/dd/yyyy
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'week'},
                        { data: 'overall_Yard_Utilization', render:
                            function (data, type) {
                                if (type === 'display') {
                                    return data + "%";
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'vessels_At_Berth'},
                        { data: 'vessels_At_Anchorage_Waiting'},
                        { data: 'last_Update', visible: false }
                    ],

                });

                $(".batangasPortUtilization_Updates").on('click', function() {
                    batangasPortUtilizationFilteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.batangasPortUtilization_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        batangasPortUtilizationTable.clear().rows.add(batangasPortUtilization.portUtilizations).draw();
                        return;
                    }

                    const categoryRanges = {
                        "Normal": [0, 80],
                        "Critical": [81, 90],
                        "Serious": [91, Infinity]
                    };

                    batangasPortUtilization.portUtilizations.forEach(item => {
                        const value = parseFloat(item.overall_Yard_Utilization);
                        if (isNaN(value)) return; // skip invalid values

                        // Find which category this value belongs to
                        for (let category in categoryRanges) {
                            const [min, max] = categoryRanges[category];
                            if (value >= min && value <= max) {
                                // Only include if this category is selected
                                if (clickedCategories.includes(category)) {
                                    batangasPortUtilizationFilteredData.push(item);
                                }
                                break; // stop checking other categories
                            }
                        }
                    });

                    // Update DataTable
                    batangasPortUtilizationTable.clear().rows.add(batangasPortUtilizationFilteredData).draw();
                });

            //#endregion

            //#region Berthing Status
                const manilaBerthName = "Manila North (MICT)";
                const batangasBerthName = "Batangas";
                let berthYear = 2025;

                let manilaBerth = await fetch(`${API_BASE_URL}/api/BerthingStatus/SpecificBerth/${manilaBerthName}/${berthYear}`);
                manilaBerth = await manilaBerth.json();
                let batangasBerth = await fetch(`${API_BASE_URL}/api/BerthingStatus/SpecificBerth/${batangasBerthName}/${berthYear}`);
                batangasBerth = await batangasBerth.json();

                //Manila North
                let manilaBerthFilteredData = [];
                const manilaBerthTable = $('#berthing-manila-table').DataTable({
                    layout: {
                        topStart: {
                            buttons: ['colvis']
                        },
                        topEnd: ['search', 'pageLength'],

                    },
                    data: manilaBerth,
                    order: [[0, "desc"]],
                    columnDefs: [
                        {className: "p-1", target: "_all"}
                    ],
                    columns: [
                        // SHIPMENT DETAILS
                        { data: 'id', visible: false },
                        { data: 'date', render: function (data, type) {
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'vesselsAtBerth'},
                        { data: 'vesselsAtAnchorage'}
                    ],

                });

                $(".manilaBerthStatus_Updates").on('click', function() {
                    manilaBerthFilteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.manilaBerthStatus_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        manilaBerthTable.clear().rows.add(manilaBerth).draw();
                        return;
                    }

                    const categoryRanges = {
                        "Normal": [0, 8],
                        "Critical": [9, 12],
                        "Serious": [13, Infinity]
                    };

                    manilaBerth.forEach(item => {
                        const value = parseFloat(item.vesselsAtAnchorage);
                        if (isNaN(value)) return; // skip invalid values

                        // Find which category this value belongs to
                        for (let category in categoryRanges) {
                            const [min, max] = categoryRanges[category];
                            if (value >= min && value <= max) {
                                // Only include if this category is selected
                                if (clickedCategories.includes(category)) {
                                    manilaBerthFilteredData.push(item);
                                }
                                break; // stop checking other categories
                            }
                        }
                    });

                    // Update DataTable
                    manilaBerthTable.clear().rows.add(manilaBerthFilteredData).draw();
                });

                //Batangas
                let batangasBerthFilteredData = [];
                const batangasBerthTable = $('#berthing-batangas-table').DataTable({
                    layout: {
                        topStart: {
                            buttons: ['colvis']
                        },
                        topEnd: ['search', 'pageLength'],

                    },
                    data: batangasBerth,
                    order: [[0, "desc"]],
                    columnDefs: [
                        {className: "p-1", target: "_all"}
                    ],
                    columns: [
                        // SHIPMENT DETAILS
                        { data: 'id', visible: false },
                        { data: 'date', render: function (data, type) {
                                if(data === null) return '';
                                if (type === 'display') {
                                    const d = new Date(data);
                                    return new Intl.DateTimeFormat('en-GB', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    }).format(d);
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { data: 'vesselsAtBerth'},
                        { data: 'vesselsAtAnchorage'}
                    ],

                });


                $(".batangasBerthStatus_Updates").on('click', function() {
                    batangasBerthFilteredData = [];

                    // Get all checked checkbox labels
                    let clickedCategories = $('.batangasBerthStatus_Updates:checked')
                        .map(function () {
                            return $(`label[for="${this.id}"]`).text().trim();
                        })
                        .get();

                    if (clickedCategories.length === 0) {
                        // No category selected → show all
                        batangasBerthTable.clear().rows.add(batangasBerth).draw();
                        return;
                    }

                    const categoryRanges = {
                        "Normal": [0, 8],
                        "Critical": [9, 12],
                        "Serious": [13, Infinity]
                    };

                    batangasBerth.forEach(item => {
                        const value = parseFloat(item.vesselsAtAnchorage);
                        if (isNaN(value)) return; // skip invalid values

                        // Find which category this value belongs to
                        for (let category in categoryRanges) {
                            const [min, max] = categoryRanges[category];
                            if (value >= min && value <= max) {
                                // Only include if this category is selected
                                if (clickedCategories.includes(category)) {
                                    batangasBerthFilteredData.push(item);
                                }
                                break; // stop checking other categories
                            }
                        }
                    });

                    // Update DataTable
                    batangasBerthTable.clear().rows.add(batangasBerthFilteredData).draw();
                });

            //#endregion

            //#region Announcements
                getAnnouncements();

                $("#createAnnouncement").on("click", function () {
                    let announcementTitle = $("#announcement-title").val();
                    let announcementDescription = $("#announcement-description").val();
                    let user = localStorage.getItem('user');
                    user = JSON.parse(user);
                    let adid = user.EmpNo;

                    let announcement = {
                        title: announcementTitle,
                        description: announcementDescription,
                        createdBy: adid
                    };

                    $.ajax({
                        url: `${API_BASE_URL}/api/Announcements`,
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(announcement),
                        success: function (data) {
                            $("#announcement-title").val("");
                            $("#announcement-description").val("");

                            swal.fire({
                                icon: "success",
                                title: "Announcement created successfully",
                                showConfirmButton: false,
                                timer: 1500
                            });

                            getAnnouncements();
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    });
                });
            //#endregion
        });

        async function getAnnouncements(){
            let announcements = await fetch(`${API_BASE_URL}/api/Announcements`)
            announcements = await announcements.json();

            announcements.forEach(item => {
                let id = item.id;
                let date = new Date(item.createdDate);

                date = date.toLocaleString("en-PH", {
                    month: "2-digit",
                    day: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true
                });

                let title = item.title;
                let description = item.description;

                let html = `
                
                    <div class="card border-primary mb-2" style="width: 100%; max-width: 350px;">
                        <div class="d-flex justify-content-between card-header"><p class="card-text"><small class="text-muted">${date}</small></p></div>
                        <div class="card-body">
                            <p>${title} </p>
                            <span>${description}</span>
                        </div>
                    </div>`;

                $('#announcement-container').append(html);
            });
        }
    </script>
}